<!doctype html>
<html lang="en" class="fx-glow">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AMI DATA PORTAL</title>
  <link rel="stylesheet" href="/styles/shared.css?v=20250306">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
  <style>
    /* Shell-specific layout */
    body.shell-app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .shell-chrome {
      position: sticky;
      top: 0;
      z-index: 9;
      display: flex;
      flex-direction: column;
      flex: 0 0 auto;
      overflow: hidden;
      background-color: var(--panel);
      background-image:
        linear-gradient(180deg, color-mix(in oklab, var(--panel) 90%, transparent) 0%, color-mix(in oklab, var(--panel) 96%, var(--accent) 6%) 100%),
        var(--chrome-gradient);
      background-size: 100% 100%, 100% 100%;
      background-blend-mode: soft-light, normal;
      border-bottom: none;
    }
    #tabsBar {
      display: flex;
      gap: 8px;
      padding: 6px 12px 0;
      align-items: flex-end;
      position: relative;
      z-index: 3;
      overflow: hidden;
    }
    .tab-strip {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      width: 100%;
    }
    .tab-strip__track {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      flex: 1 1 auto;
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 0;
      scrollbar-width: none;
    }
    .tab-strip__track::-webkit-scrollbar { display: none; }
    .tab-strip__add {
      flex: 0 0 auto;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(0, 0, 0, 0.42);
      color: rgba(255, 255, 255, 0.86);
      font-weight: 600;
      cursor: pointer;
      height: 32px;
      min-width: 32px;
      transition: background var(--duration-medium) var(--easing-standard),
        border-color var(--duration-medium) var(--easing-standard),
        color var(--duration-medium) var(--easing-standard);
    }
    .tab-strip__add:hover {
      background: rgba(0, 0, 0, 0.58);
      border-color: rgba(255, 255, 255, 0.2);
    }
    .tab-strip__add:focus-visible {
      outline: none;
      box-shadow: 0 0 0 2px color-mix(in oklab, var(--accent) 35%, transparent);
    }
    body.shell-app > .shell-chrome { flex: 0 0 auto; }
    .tab {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-bottom-color: rgba(255, 255, 255, 0.06);
      background: rgba(0, 0, 0, 0.42);
      color: rgba(255, 255, 255, 1);
      border-radius: 12px 12px 0 0;
      cursor: pointer;
      margin-bottom: -1px;
      position: relative;
      transition:
        color var(--duration-medium) var(--easing-standard),
        background var(--duration-medium) var(--easing-standard),
        border-color var(--duration-medium) var(--easing-standard),
        box-shadow var(--duration-medium) var(--easing-standard),
        padding var(--duration-medium) var(--easing-standard);
      will-change: transform;
    }
    .tab:not(.active):hover {
      background: rgba(0, 0, 0, 0.54);
      color: rgba(255, 255, 255, 1);
      border-color: rgba(255, 255, 255, 0.18);
    }
    .tab:focus-visible {
      outline: none;
      box-shadow: 0 0 0 2px color-mix(in oklab, var(--accent) 35%, transparent);
    }
    .tab.active {
      padding: 8px 16px;
      background: var(--bg);
      color: var(--text);
      border-color: color-mix(in oklab, var(--border) 45%, transparent);
      border-bottom-color: transparent;
      box-shadow:
        -18px 0 28px -20px rgba(0, 0, 0, 0.55),
        18px 0 28px -20px rgba(0, 0, 0, 0.55);
      z-index: 4;
    }
    .tab.active:focus-visible {
      box-shadow:
        -12px 0 24px rgba(0, 0, 0, 0.4),
        12px 0 24px rgba(0, 0, 0, 0.4),
        0 0 0 2px color-mix(in oklab, var(--accent) 35%, transparent);
    }
    .tab .icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      font-size: 18px;
      color: inherit;
    }
    .tab .status-indicator {
      margin-left: 6px;
    }
    .tab__label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      line-height: 1.1;
    }
    .tab .icon i {
      font-size: inherit;
      line-height: 1;
      color: inherit;
    }
    /* Served: bump icon size; keep default color */
    .tab.served .icon {
      width: 18px;
      height: 18px;
      font-size: 18px;
    }
    /* Served indicator: unified green dot */
    .tab .pill { margin-left: 6px; }
    .tab .close {
      margin-left: 8px;
      opacity: 0.8;
      font-size: 18px;
      line-height: 1;
      width: 20px;
      height: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .tab.dragging {
      cursor: grabbing;
      background: var(--bg);
      color: var(--text);
      border-color: color-mix(in oklab, var(--border) 45%, transparent);
      border-bottom-color: var(--bg);
      padding: 8px 16px;
    }
    .frame-wrap {
      position: relative;
      flex: 1 1 auto;
      min-height: 0;
      background: #111;
      margin-top: -1px;
      overflow: hidden;
    }
    .frame-loading {
      position: absolute;
      inset: 0;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 14px;
      padding: 24px;
      background:
        radial-gradient(circle at top, color-mix(in oklab, var(--bg) 65%, transparent) 0%, transparent 72%),
        color-mix(in oklab, var(--panel) 82%, transparent);
      backdrop-filter: blur(var(--overlay-blur-strength));
      opacity: 0;
      pointer-events: none;
      transition: opacity 160ms var(--easing-standard);
    }
    .frame-loading--active {
      opacity: 1;
      pointer-events: auto;
    }
    .frame-loading__inner {
      display: inline-flex;
      align-items: center;
      gap: 14px;
      padding: 14px 18px;
      border-radius: 14px;
      background: rgba(7, 9, 14, 0.72);
      box-shadow: 0 18px 42px rgba(0, 0, 0, 0.42);
      border: 1px solid color-mix(in oklab, var(--border) 60%, transparent);
    }
    .frame-loading__spinner {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.18);
      border-top-color: color-mix(in oklab, var(--accent) 78%, white 22%);
      animation: frame-loading-spin 620ms linear infinite;
    }
    .frame-loading__label {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.015em;
      color: rgba(255, 255, 255, 0.92);
      text-transform: uppercase;
    }
    @keyframes frame-loading-spin {
      to { transform: rotate(360deg); }
    }
    /* Default dark; for file modes (A/B) use a light gray gradient */
    body.mode-file .frame-wrap {
      background: linear-gradient(180deg, #f7f7f8 0%, #ededf0 100%);
    }
    .viz-frame-host {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    .viz-frame {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
      background: transparent;
      display: none;
    }
    .viz-frame.is-active {
      display: block;
    }
    header .right { display: inline-flex; gap: 8px; align-items: center; margin-left: auto; }
    #pathLabel { color: var(--muted); max-width: 40vw; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    /* Branding */
    .brand {
      display: inline-flex;
      align-items: center;
      gap: 16px;
      min-width: 300px;
    }
    .brand-logo-button {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      padding: 0;
      border: 0;
      border-radius: 50%;
      background: none;
      cursor: pointer;
      margin-left: 8px;
    }
    .brand-logo-button:focus-visible {
      outline: 2px solid color-mix(in oklab, var(--accent) 62%, white 38%);
      outline-offset: 3px;
    }
    .brand-logo {
      position: relative;
      width: 48px;
      height: 48px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .brand-logo canvas {
      position: absolute;
      inset: 0;
      width: 48px;
      height: 48px;
      display: block;
      opacity: 0.16;
    }
    .brand-clock {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      text-align: center;
    }
    .brand-clock__date {
      font-family: 'Montserrat', 'Helvetica Neue', Arial, sans-serif;
      font-size: 18px;
      font-weight: 200;
      letter-spacing: 0.24em;
      color: rgba(255, 255, 255, 0.86);
      text-transform: uppercase;
      line-height: 1;
      margin-top: 0.4rem;
    }
    .brand-clock__time {
      font-family: 'Montserrat', 'Helvetica Neue', Arial, sans-serif;
      font-size: 15px;
      font-weight: 900;
      letter-spacing: 0.26em;
      color: rgba(255, 255, 255, 0.98);
      text-transform: uppercase;
      line-height: 1;
    }
    .brand-text {
      display: flex;
      align-items: center;
      color: #fff;
    }
    .brand-text__stack {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.06rem;
      text-align: left;
    }
    .brand-text__title {
      margin: 0;
      font-size: 20px;
      font-weight: 800;
      letter-spacing: 0.08em;
      color: #fff;
      text-transform: uppercase;
    }
    .brand-text__subtitle {
      font-size: 13px;
      line-height: 1.1;
      letter-spacing: 0.16em;
      color: rgba(255, 255, 255, 0.82);
      text-transform: uppercase;
      font-family: 'Roboto Mono', 'IBM Plex Mono', 'SFMono-Regular', Menlo, Monaco,
        Consolas, 'Liberation Mono', 'Courier New', monospace;
      display: inline-flex;
      gap: 0.08em;
      white-space: pre;
      font-variant-ligatures: none;
      font-variant-numeric: tabular-nums;
      font-feature-settings: 'liga' 0, 'clig' 0;
    }
    .brand-text__subtitle span {
      display: inline-block;
      transition:
        filter 280ms cubic-bezier(0.4, 0, 0.2, 1),
        color 320ms cubic-bezier(0.33, 0, 0.2, 1),
        opacity 260ms cubic-bezier(0.4, 0, 0.2, 1);
      will-change: filter, color, opacity;
      filter: blur(0px);
      width: 1ch;
      min-width: 1ch;
      text-align: center;
    }
    .brand-text__subtitle span.is-morphing {
      filter: blur(4px);
      color: rgba(255, 255, 255, 0.92);
      opacity: 0.5;
    }
    .brand-singularity-dialog {
      width: min(560px, calc(100vw - 48px));
      max-height: min(92vh, 720px);
      margin: auto;
      padding: 28px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      background: color-mix(in oklab, var(--panel) 65%, transparent);
      border-radius: 22px;
      border: 1px solid color-mix(in oklab, var(--border) 68%, transparent);
      box-shadow: 0 42px 120px rgba(0, 0, 0, 0.48);
      overflow: hidden;
    }
    .brand-singularity-dialog .dialog-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
    }
    .brand-singularity-dialog__canvas-wrap {
      position: relative;
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 18px;
      overflow: hidden;
      background: #000;
    }
    .brand-singularity-dialog__canvas-wrap canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      display: block;
    }
    .brand-singularity-dialog__fps {
      position: absolute;
      right: 18px;
      bottom: 18px;
      padding: 0;
      border-radius: 0;
      background: none;
      color: #fff;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 13px;
      filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.55));
      pointer-events: none;
    }
    .is-hidden { display: none !important; }
    .welcome-screen {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      overflow: hidden;
      background:
        radial-gradient(circle at top, color-mix(in oklab, var(--accent) 18%, transparent) 0%, transparent 62%),
        color-mix(in oklab, var(--panel) 94%, transparent);
      z-index: 3;
    }
    .welcome-card {
      position: relative;
      width: min(480px, 100%);
      margin: auto;
      padding: 48px 36px;
      border-radius: 18px;
      border: 1px solid color-mix(in oklab, var(--border) 55%, transparent);
      background-color: color-mix(in oklab, var(--panel) 58%, white 42%);
      background-image:
        linear-gradient(155deg, color-mix(in oklab, var(--accent) 16%, transparent) 0%, transparent 68%),
        var(--chrome-gradient);
      background-size: 100% 100%, 200% 100%;
      background-repeat: no-repeat, repeat;
      background-blend-mode: screen, normal;
      box-shadow: 0 32px 90px rgba(0,0,0,0.32);
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 18px;
      overflow: hidden;
    }
    .welcome-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: var(--chrome-gradient);
      background-size: 260% 260%;
      opacity: 0.5;
      mix-blend-mode: color-dodge;
      filter: hue-rotate(0deg);
      animation: pixel-drift 28s linear infinite, pixel-spectrum 48s ease-in-out infinite;
      pointer-events: none;
    }
    .welcome-card > * { position: relative; z-index: 1; }
    @keyframes pixel-drift {
      0% { background-position: 0 0; }
      50% { background-position: 16px 12px; }
      100% { background-position: 0 0; }
    }
    @keyframes pixel-spectrum {
      0% { filter: hue-rotate(0deg); }
      50% { filter: hue-rotate(180deg); }
      100% { filter: hue-rotate(360deg); }
    }
    .welcome-card h2 {
      margin: 0;
      font-size: 28px;
      letter-spacing: -0.01em;
    }
    .welcome-card p { margin: 0; color: var(--muted); font-size: 15px; }
    .welcome-card .welcome-action {
      font-size: 18px;
      padding: 16px 28px;
      border-radius: 999px;
      border-width: 2px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }
    .welcome-card .welcome-hint { font-size: 12px; }
    :root {
      --chrome-gradient: linear-gradient(135deg, #000 0%, #fff 100%);
    }
    header {
      position: relative;
      top: auto;
      z-index: auto;
      background: transparent;
      box-shadow: none;
    }
    header > *, .welcome-screen > * { position: relative; z-index: 1; }
    .welcome-card { position: relative; z-index: 2; }
  </style>
  <script>
    (function() {
      try {
        const theme = localStorage.getItem('theme');
        if (theme) document.documentElement.setAttribute('data-theme', theme);
        // Always enable glow effect
        document.documentElement.classList.add('fx-glow');
      } catch {}
    })();
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;400;500;600;700;900&display=swap">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css">
</head>
<body class="shell-app">
  <div id="shellConsole" class="shell-console" aria-hidden="true">
    <div class="shell-console__inner">
      <div class="shell-console__tabs">
        <div id="shellConsoleTabs" class="console-tab-strip" role="tablist"></div>
      </div>
      <div id="shellConsoleViewport" class="shell-console__terminal" role="presentation"></div>
    </div>
  </div>

  <div class="shell-chrome">
    <header>
      <div class="brand">
        <button id="brandSingularityTrigger" class="brand-logo-button" type="button" aria-label="System clock" aria-expanded="false">
          <div class="brand-logo brand-logo--singularity">
            <canvas id="brandSingularity" width="72" height="72" aria-hidden="true"></canvas>
            <div class="brand-clock" aria-live="polite">
              <span class="brand-clock__date">01.01</span>
              <span class="brand-clock__time">13:37</span>
            </div>
          </div>
        </button>
        <div class="brand-text">
          <div class="brand-text__stack">
            <h1 class="brand-text__title">AMI DATA PORTAL</h1>
            <div class="brand-text__subtitle muted">LIVE CONTENT DIRECTORY</div>
          </div>
        </div>
      </div>
      <input id="globalSearch" type="search" placeholder="Search (/)" />
      <button class="icon-button" id="btnTheme" data-hint="Toggle Theme" aria-label="Toggle Theme"><i id="iconTheme" class="ri-moon-clear-line" aria-hidden="true"></i></button>
      <button class="icon-button" id="selectMediaBtn" data-hint="Content Directory" aria-label="Content Directory">
        <i class="ri-folders-line" aria-hidden="true"></i>
      </button>
      <button class="icon-button" id="accountDrawerBtn" data-hint="Account Management" aria-label="Account Management">
        <i class="ri-user-settings-line" aria-hidden="true"></i>
      </button>
      <span class="right">
        <span id="statusPill" class="muted"></span>
        <span id="pathLabel" class="muted"></span>
      </span>
    </header>

    <div id="tabsBar"></div>
  </div>
  <div class="frame-wrap">
    <div id="frameLoadingOverlay" class="frame-loading" aria-hidden="true">
      <div class="frame-loading__inner">
        <div class="frame-loading__spinner" aria-hidden="true"></div>
        <span class="frame-loading__label">Loading…</span>
      </div>
    </div>
    <div id="vizFrameHost" class="viz-frame-host" aria-live="polite"></div>
    <div id="welcomeScreen" class="welcome-screen">
      <div class="welcome-card">
        <h2>Welcome to the AMI Data Portal</h2>
        <p>Open the Content Directory to browse playbooks, resources, and live tools.</p>
        <button id="welcomeOpenBtn" class="btn welcome-action">
          <i class="ri-folders-line" aria-hidden="true"></i>
          Open Content Directory
        </button>
        <p class="welcome-hint muted">Tip: press / to focus search once you have a workspace open.</p>
      </div>
    </div>
  </div>

  <div id="brandSingularityDialog" class="dialog-backdrop" hidden aria-hidden="true">
    <div class="dialog-surface brand-singularity-dialog" role="dialog" aria-modal="true" aria-labelledby="brandSingularityDialogTitle">
      <div class="dialog-header">
        <div class="dialog-header__titles">
          <h2 id="brandSingularityDialogTitle" class="dialog-title">Singularity Simulation Benchmark</h2>
          <div class="dialog-subtitle">Monochromatic point cloud accretion disk</div>
        </div>
        <button class="icon-button dialog-close" type="button" aria-label="Close singularity simulation" data-hint="Close">
          <i class="ri-close-large-line" aria-hidden="true"></i>
        </button>
      </div>
      <div class="brand-singularity-dialog__canvas-wrap">
        <canvas id="brandSingularityLarge" width="640" height="640" aria-describedby="brandSingularityDialogTitle"></canvas>
        <div class="brand-singularity-dialog__fps" id="brandSingularityFps" aria-live="polite">— fps</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { attachLensFlare } from '/sim/lens-flare.js?v=20250306'
    import { attachBlackHoleSimulation } from '/sim/black-hole.js?v=20250306'
    import { dialogService } from '/js/dialog-service.js?v=20250306'
    try {
      const trigger = document.getElementById('brandSingularityTrigger')
      const canvas = document.getElementById('brandSingularity')
      const dialogOverlay = document.getElementById('brandSingularityDialog')
      const dialogSurface = dialogOverlay?.querySelector('.dialog-surface')
      const closeButton = dialogOverlay?.querySelector('.dialog-close')
      const largeCanvas = document.getElementById('brandSingularityLarge')
      const fpsLabel = document.getElementById('brandSingularityFps')
      const clockDate = document.querySelector('.brand-clock__date')
      const clockTime = document.querySelector('.brand-clock__time')
      const subtitle = document.querySelector('.brand-text__subtitle')
      let lensTeardown = null
      let largeTeardown = null
      let dialogHandle = null
      let clockTimer = null

      const updateClock = () => {
        if (!clockDate || !clockTime) return
        const now = new Date()
        const day = String(now.getDate()).padStart(2, '0')
        const month = String(now.getMonth() + 1).padStart(2, '0')
        const hours = String(now.getHours()).padStart(2, '0')
        const minutes = String(now.getMinutes()).padStart(2, '0')
        clockDate.textContent = `${day}.${month}`
        clockTime.textContent = `${hours}:${minutes}`
      }

      const scheduleClock = () => {
        if (!clockDate || !clockTime) return
        if (clockTimer) {
          clearTimeout(clockTimer)
        }
        updateClock()
        const now = new Date()
        const delay = Math.max(1000, 60000 - (now.getSeconds() * 1000 + now.getMilliseconds()))
        clockTimer = window.setTimeout(scheduleClock, delay)
      }

      if (clockDate && clockTime) {
        scheduleClock()
      }

      if (subtitle) {
        const originalText = subtitle.textContent || ''
        const characters = Array.from(originalText)
        subtitle.textContent = ''

        const spans = characters.map((char, index) => {
          const span = document.createElement('span')
          const isMutable = char !== ' '
          span.dataset.index = String(index)
          span.dataset.original = char
          span.dataset.state = 'original'
          span.dataset.mutable = isMutable ? 'true' : 'false'
          span.textContent = char
          subtitle.appendChild(span)
          return span
        })

        const glyphMap = {
          A: 'AΛΔ∀ꓮ',
          B: 'Bß฿𝔅',
          C: 'CϾ₵ℂ',
          D: 'DĐÐ',
          E: 'EΞΣɆ',
          F: 'FҒҒ',
          G: 'Gɢ',
          H: 'HΉĦ♓',
          I: 'I1|∣І',
          J: 'Jʝ',
          K: 'KҜҠ',
          L: 'LĿŁ',
          M: 'MΜϺ',
          N: 'NИŅ',
          O: 'O0ΘΦΩ⊙◎',
          P: 'P₱Р',
          Q: 'QΩҨ',
          R: 'RЯŖ',
          S: 'S5§Ϩ',
          T: 'T⊤Ŧ',
          U: 'UՍЧ',
          V: 'VѴ▽',
          W: 'WШѠ',
          X: 'XЖ✕✖',
          Y: 'Y¥Ψ',
          Z: 'ZƵɀ',
          '0': '0OΘΦ⊘',
          '1': '1I|Ɩ',
          '2': '2ƻ',
          '3': '3Ɛ',
          '4': '4Δ',
          '5': '5Ƽ',
          '6': '6б',
          '7': '7Γ',
          '8': '8∞',
          '9': '9Ϛ',
        }

        const randomGlyph = (baseline) => {
          if (!baseline) return '?'
          const key = baseline.toUpperCase()
          const pool = glyphMap[key] ? Array.from(new Set((baseline + glyphMap[key]).split(''))) : [baseline]
          if (!pool.length) return baseline
          const filtered = pool.filter((glyph) => glyph !== baseline)
          const choices = filtered.length ? filtered : pool
          return choices[Math.floor(Math.random() * choices.length)]
        }

        let subtitleTimer = null
        let restoreAccumulator = 0

        const scheduleSubtitleMorph = () => {
          const delay = 520 + Math.random() * 840
          subtitleTimer = window.setTimeout(() => {
            if (!spans.length) {
              scheduleSubtitleMorph()
              return
            }

            restoreAccumulator += 1
            const mutatedSpans = spans.filter((span) => span.dataset.state === 'mutated')
            const eligibleOriginals = spans.filter(
              (span) => span.dataset.state !== 'mutated' && span.dataset.mutable === 'true',
            )

            const shouldRestore = restoreAccumulator >= 2.5 && mutatedSpans.length > 0
            const actionPool = shouldRestore ? mutatedSpans : eligibleOriginals

            if (!actionPool.length) {
              if (mutatedSpans.length) {
                // fallback: force restore if no originals left but mutated remain
                const fallback = mutatedSpans[Math.floor(Math.random() * mutatedSpans.length)]
                fallback.dataset.state = 'original'
                fallback.textContent = fallback.dataset.original || ''
                fallback.classList.add('is-morphing')
                restoreAccumulator -= 2.5
                if (restoreAccumulator < 0) restoreAccumulator = 0
                window.setTimeout(() => fallback.classList.remove('is-morphing'), 320)
              }
              scheduleSubtitleMorph()
              return
            }

            const target = actionPool[Math.floor(Math.random() * actionPool.length)]
            if (!target) {
              scheduleSubtitleMorph()
              return
            }

            target.classList.add('is-morphing')
            if (shouldRestore) {
              restoreAccumulator -= 2.5
              if (restoreAccumulator < 0) restoreAccumulator = 0
              target.dataset.state = 'original'
              target.textContent = target.dataset.original || ''
            } else {
              target.dataset.state = 'mutated'
              const originalChar = target.dataset.original || ''
              target.textContent = randomGlyph(originalChar)
            }

            window.setTimeout(() => {
              target.classList.remove('is-morphing')
            }, 320)

            scheduleSubtitleMorph()
          }, delay)
        }

        scheduleSubtitleMorph()

        window.addEventListener(
          'beforeunload',
          () => {
            if (subtitleTimer) {
              clearTimeout(subtitleTimer)
              subtitleTimer = null
            }
          },
          { once: true },
        )
      }

      if (canvas) {
        lensTeardown = attachLensFlare(canvas, {
          count: 24,
        })
        canvas.classList.add('is-ready')
      }

      if (trigger && dialogOverlay && dialogSurface && largeCanvas) {
        dialogHandle = dialogService.register('brand-singularity', {
          overlay: dialogOverlay,
          surface: dialogSurface,
          onOpen: () => {
            trigger?.setAttribute('aria-expanded', 'true')
            if (!largeTeardown) {
              largeTeardown = attachBlackHoleSimulation(largeCanvas, {
                enableAccretionDisk: true,
                maxIterations: 420,
                cameraSwing: 0.94,
                resolutionScale: 2.45,
                onFps: (fps) => {
                  if (!fpsLabel) return
                  const value = Number.isFinite(fps) ? Math.max(0, Math.round(fps)) : 0
                  fpsLabel.textContent = `${value} fps`
                },
              })
            }
          },
          onClose: () => {
            trigger?.setAttribute('aria-expanded', 'false')
            if (typeof largeTeardown === 'function') {
              try { largeTeardown() } catch {}
            }
            largeTeardown = null
            if (fpsLabel) fpsLabel.textContent = '— fps'
          },
        })

        const openDialog = () => dialogHandle?.open()
        trigger?.addEventListener('click', openDialog)
        closeButton?.addEventListener('click', () => dialogHandle?.close())
      }

      window.addEventListener('beforeunload', () => {
        try { lensTeardown?.() } catch {}
        try { largeTeardown?.() } catch {}
        if (dialogHandle) {
          try { dialogService.unregister('brand-singularity') } catch {}
          dialogHandle = null
        }
        if (clockTimer) {
          clearTimeout(clockTimer)
          clockTimer = null
        }
      }, { once: true })
    } catch (error) {
      console.warn('[black-hole] init failed', error)
    }
  </script>

  <script defer src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
  <script type="module" src="/js/shell.js?v=20250306"></script>
  <style>
    /* Hide mode/path noise in shell header */
    #pathLabel { display: none !important; }
  </style>
</body>
</html>
